<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labour Calculator – Stick Build vs Prefab</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background:#0b0c10; color:#e8e8e8; }
    .card { background:#111318; border:1px solid #1f232b; }
    .table thead th { position: sticky; top:0; background:#0f1116; z-index:1; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    .small-muted { font-size: .85rem; color:#9aa0a6; }
    .btn-icon { padding:.25rem .5rem; }
    .form-control, .form-select { background:#0f1116!important; color:#e8e8e8!important; border-color:#272b33!important; }
    .form-control:focus { box-shadow: 0 0 0 .15rem rgba(13,110,253,.25); }
    .table-input { width: 5.5rem; }
    .table-input-compact { width: 4.5rem; }
    .area-input { min-width: 7rem; }
    .totals-pill { background:#0f1116; border:1px solid #272b33; border-radius: 999px; padding:.5rem 1rem; }
    .footer-note { font-size:.9rem; color:#b9bec6; }
    .brand { font-weight:700; letter-spacing:.3px; }
    .sticky-actions { position: sticky; bottom: 0; background: rgba(11,12,16,.9); backdrop-filter: blur(6px); border-top:1px solid #1f232b; padding:.75rem; }
    /* Fix for hidden file input */
    #importFile {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
    /* Chart container sizing */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .comparison-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .badge-stick {
      background: rgba(51, 153, 255, 0.2);
      color: #3399ff;
      border: 1px solid rgba(51, 153, 255, 0.4);
    }
    .badge-prefab {
      background: rgba(255, 153, 51, 0.2);
      color: #ff9933;
      border: 1px solid rgba(255, 153, 51, 0.4);
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 brand mb-0">Labour Calculator</h1>
      <div>
        <button id="btnExport" class="btn btn-outline-light btn-sm me-2">Export</button>
        <input id="importFile" type="file" accept="application/json">
        <button id="btnImport" class="btn btn-outline-light btn-sm">Import</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12 col-md-6">
        <div class="card p-3">
          <div class="row g-2">
            <div class="col-12 col-sm-7">
              <label class="form-label">Project name</label>
              <input id="projectName" class="form-control" placeholder="e.g., Ballarat" />
            </div>
            <div class="col-12 col-sm-5">
              <label class="form-label">Project Job Number</label>
              <input id="projectNumber" class="form-control" placeholder="e.g., ENT-XXXX" />
            </div>
          </div>
          <div class="small-muted mt-2">Enter <b>Days</b> and <b>People</b>. Hours auto-calc: Days × People × 8.</div>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="card p-3">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <button id="addRow" class="btn btn-primary">+ Add Area / Riser</button>
            <button id="clearAll" class="btn btn-outline-danger">Clear all</button>
            <button id="emailBtn" class="btn btn-success ms-auto">Email Results</button>
          </div>
          <div class="small-muted mt-2">Results are also saved to your browser (local only).</div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="table-responsive">
        <table id="labourTable" class="table table-dark align-middle mb-0">
          <thead>
            <tr>
              <th class="text-nowrap">Area / Riser No</th>
              <th class="text-center" colspan="3">Labour hours to Install on site (Stick build) ductwork in riser</th>
              <th class="text-center" colspan="3">Labour hours to Install for prefab frames</th>
              <th class="text-center" colspan="3">Labour required for Crane Lift</th>
              <th class="text-center">Total Hours per riser</th>
              <th></th>
            </tr>
            <tr>
              <th></th>
              <th class="text-center">Days</th>
              <th class="text-center">People</th>
              <th class="text-center">Hours</th>
              <th class="text-center">Days</th>
              <th class="text-center">People</th>
              <th class="text-center">Hours</th>
              <th class="text-center">Days</th>
              <th class="text-center">People</th>
              <th class="text-center">Hours</th>
              <th class="text-center">Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
          <tfoot>
            <tr>
              <th class="text-end">Totals</th>
              <th class="text-center"><span id="tDaysStick">0</span></th>
              <th class="text-center"><span id="tPeopleStick">0</span></th>
              <th class="text-center"><span id="tHoursStick">0</span></th>
              <th class="text-center"><span id="tDaysPrefab">0</span></th>
              <th class="text-center"><span id="tPeoplePrefab">0</span></th>
              <th class="text-center"><span id="tHoursPrefab">0</span></th>
              <th class="text-center"><span id="tDaysCrane">0</span></th>
              <th class="text-center"><span id="tPeopleCrane">0</span></th>
              <th class="text-center"><span id="tHoursCrane">0</span></th>
              <th class="text-center"><span id="tHoursTotal">0</span></th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-12 col-xl-6">
        <div class="card p-3 h-100">
          <h2 class="h5">Total Hours Comparison</h2>
          <div class="chart-container">
            <canvas id="totalsChart"></canvas>
          </div>
          <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="comparison-badge badge-stick">Stick Build: <strong id="compStick">0</strong> hrs</span>
              <span class="comparison-badge badge-prefab">Prefab + Crane: <strong id="compPrefab">0</strong> hrs</span>
            </div>
            <div class="text-center mt-2">
              <small class="text-muted">Savings with Prefab: <strong id="savingsPercent">0</strong>%</small>
            </div>
          </div>
          <p class="small-muted mt-2">Compares total hours: Stick Build vs Prefab (including crane lift).</p>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card p-3 h-100">
          <h2 class="h5">Per-Riser Hours Breakdown</h2>
          <div class="chart-container">
            <canvas id="perRiserChart"></canvas>
          </div>
          <p class="small-muted mt-2">Detailed breakdown showing Stick, Prefab, and Crane hours for each riser.</p>
        </div>
      </div>
    </div>

    <div class="sticky-actions mt-3 d-flex flex-wrap gap-2 align-items-center">
      <div class="totals-pill">
        <span class="me-2">Stick: <b id="pillStick">0</b> h</span>
        <span class="me-2">Prefab: <b id="pillPrefab">0</b> h</span>
        <span class="me-2">Crane: <b id="pillCrane">0</b> h</span>
        <span>Total: <b id="pillTotal">0</b> h</span>
      </div>
      <div class="ms-auto small footer-note">© Labour Calculator – mobile-ready. Save/export/import supported.</div>
    </div>
  </div>

<script>
const HOURS_PER_DAY = 8;

const tableBody = document.querySelector('#labourTable tbody');
const addRowBtn = document.getElementById('addRow');
const clearAllBtn = document.getElementById('clearAll');
const emailBtn = document.getElementById('emailBtn');
const projectNameEl = document.getElementById('projectName');
const projectNumberEl = document.getElementById('projectNumber');

const totals = {
  days: {stick:0,prefab:0,crane:0},
  people: {stick:0,prefab:0,crane:0},
  hours: {stick:0,prefab:0,crane:0,total:0}
};

function fmt(n){ return (Math.round((n + Number.EPSILON)*100)/100).toString(); }

function makeCellInput(type, placeholder, cls='table-input-compact'){
  const input = document.createElement('input');
  input.type = 'number';
  input.step = 'any';
  input.min = '0';
  input.placeholder = placeholder;
  input.className = 'form-control form-control-sm ' + cls;
  return input;
}

function addRow(data){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="form-control form-control-sm area-input" placeholder="e.g., 02a"></td>
    <td class="text-center"></td>
    <td class="text-center"></td>
    <td class="text-center fw-semibold">0</td>
    <td class="text-center"></td>
    <td class="text-center"></td>
    <td class="text-center fw-semibold">0</td>
    <td class="text-center"></td>
    <td class="text-center"></td>
    <td class="text-center fw-semibold">0</td>
    <td class="text-center fw-bold">0</td>
    <td class="text-end"><button class="btn btn-outline-danger btn-sm btn-icon">✕</button></td>
  `;
  tableBody.appendChild(tr);

  const area = tr.children[0].querySelector('input');

  // Create inputs for the 3 groups (Days/People for stick, prefab, crane)
  const stickDays = makeCellInput('number','Days');
  const stickPeople = makeCellInput('number','People');
  tr.children[1].appendChild(stickDays);
  tr.children[2].appendChild(stickPeople);

  const prefabDays = makeCellInput('number','Days');
  const prefabPeople = makeCellInput('number','People');
  tr.children[4].appendChild(prefabDays);
  tr.children[5].appendChild(prefabPeople);

  const craneDays = makeCellInput('number','Days');
  const cranePeople = makeCellInput('number','People');
  tr.children[7].appendChild(craneDays);
  tr.children[8].appendChild(cranePeople);

  const delBtn = tr.children[11].querySelector('button');
  delBtn.addEventListener('click', () => {
    tr.remove();
    updateTotals();
    saveState();
  });

  function calcRow(){
    const sd = parseFloat(stickDays.value) || 0;
    const sp = parseFloat(stickPeople.value) || 0;
    const sh = sd * sp * HOURS_PER_DAY;
    tr.children[3].textContent = fmt(sh);

    const pd = parseFloat(prefabDays.value) || 0;
    const pp = parseFloat(prefabPeople.value) || 0;
    const ph = pd * pp * HOURS_PER_DAY;
    tr.children[6].textContent = fmt(ph);

    const cd = parseFloat(craneDays.value) || 0;
    const cp = parseFloat(cranePeople.value) || 0;
    const ch = cd * cp * HOURS_PER_DAY;
    tr.children[9].textContent = fmt(ch);

    const total = sh + ph + ch;
    tr.children[10].textContent = fmt(total);

    updateTotals();
    saveState();
  }

  // Event listeners
  stickDays.addEventListener('input', calcRow);
  stickPeople.addEventListener('input', calcRow);
  prefabDays.addEventListener('input', calcRow);
  prefabPeople.addEventListener('input', calcRow);
  craneDays.addEventListener('input', calcRow);
  cranePeople.addEventListener('input', calcRow);
  area.addEventListener('input', saveState);

  // Load data if provided
  if(data){
    area.value = data.area || '';
    stickDays.value = data.stickDays || '';
    stickPeople.value = data.stickPeople || '';
    prefabDays.value = data.prefabDays || '';
    prefabPeople.value = data.prefabPeople || '';
    craneDays.value = data.craneDays || '';
    cranePeople.value = data.cranePeople || '';
    calcRow();
  }
}

function updateTotals(){
  // Reset all totals
  totals.days.stick = totals.days.prefab = totals.days.crane = 0;
  totals.people.stick = totals.people.prefab = totals.people.crane = 0;
  totals.hours.stick = totals.hours.prefab = totals.hours.crane = totals.hours.total = 0;

  Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
    const cells = tr.children;
    const sd = parseFloat(cells[1].querySelector('input').value) || 0;
    const sp = parseFloat(cells[2].querySelector('input').value) || 0;
    const pd = parseFloat(cells[4].querySelector('input').value) || 0;
    const pp = parseFloat(cells[5].querySelector('input').value) || 0;
    const cd = parseFloat(cells[7].querySelector('input').value) || 0;
    const cp = parseFloat(cells[8].querySelector('input').value) || 0;

    totals.days.stick += sd;
    totals.days.prefab += pd;
    totals.days.crane += cd;
    totals.people.stick += sp;
    totals.people.prefab += pp;
    totals.people.crane += cp;

    const sh = sd * sp * HOURS_PER_DAY;
    const ph = pd * pp * HOURS_PER_DAY;
    const ch = cd * cp * HOURS_PER_DAY;
    totals.hours.stick += sh;
    totals.hours.prefab += ph;
    totals.hours.crane += ch;
    totals.hours.total += (sh + ph + ch);
  });

  // Update the display
  document.getElementById('tDaysStick').textContent = fmt(totals.days.stick);
  document.getElementById('tDaysPrefab').textContent = fmt(totals.days.prefab);
  document.getElementById('tDaysCrane').textContent = fmt(totals.days.crane);
  document.getElementById('tPeopleStick').textContent = fmt(totals.people.stick);
  document.getElementById('tPeoplePrefab').textContent = fmt(totals.people.prefab);
  document.getElementById('tPeopleCrane').textContent = fmt(totals.people.crane);
  document.getElementById('tHoursStick').textContent = fmt(totals.hours.stick);
  document.getElementById('tHoursPrefab').textContent = fmt(totals.hours.prefab);
  document.getElementById('tHoursCrane').textContent = fmt(totals.hours.crane);
  document.getElementById('tHoursTotal').textContent = fmt(totals.hours.total);

  // Update pills
  document.getElementById('pillStick').textContent = fmt(totals.hours.stick);
  document.getElementById('pillPrefab').textContent = fmt(totals.hours.prefab);
  document.getElementById('pillCrane').textContent = fmt(totals.hours.crane);
  document.getElementById('pillTotal').textContent = fmt(totals.hours.total);

  // Update comparison values
  const stickTotal = totals.hours.stick;
  const prefabTotal = totals.hours.prefab + totals.hours.crane; // Combine prefab and crane
  
  document.getElementById('compStick').textContent = fmt(stickTotal);
  document.getElementById('compPrefab').textContent = fmt(prefabTotal);
  
  // Calculate savings percentage
  if (stickTotal > 0) {
    const savings = ((stickTotal - prefabTotal) / stickTotal) * 100;
    document.getElementById('savingsPercent').textContent = fmt(savings);
  } else {
    document.getElementById('savingsPercent').textContent = '0';
  }

  updateCharts();
}

// Chart setup
let totalsChart, perRiserChart;

function buildCharts(){
  // Destroy existing charts if they exist
  if(totalsChart) {
    totalsChart.destroy();
  }
  if(perRiserChart) {
    perRiserChart.destroy();
  }

  const stickColor = 'rgba(51, 153, 255, 0.8)';
  const prefabColor = 'rgba(255, 153, 51, 0.8)';
  const craneColor = 'rgba(51, 255, 153, 0.8)';
  const prefabComboColor = 'rgba(255, 153, 51, 0.9)'; // Slightly different for combined
  const axisColor = '#a0a0a0';
  const gridColor = 'rgba(255,255,255,0.1)';

  // Totals comparison chart - Now showing Stick vs (Prefab + Crane)
  const totalsCtx = document.getElementById('totalsChart').getContext('2d');
  totalsChart = new Chart(totalsCtx, {
    type: 'bar',
    data: {
      labels: ['Stick Build On-Site', 'Prefab + Crane Install'],
      datasets: [{
        label: 'Total Hours',
        data: [0, 0],
        backgroundColor: [stickColor, prefabComboColor],
        borderColor: [stickColor, prefabComboColor],
        borderWidth: 2,
        barPercentage: 0.6,
        categoryPercentage: 0.8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: false 
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed.y || 0;
              if (label === 'Prefab + Crane Install') {
                const prefabHours = totals.hours.prefab;
                const craneHours = totals.hours.crane;
                return [
                  `Total: ${fmt(value)} hours`,
                  `├─ Prefab: ${fmt(prefabHours)} hrs`,
                  `└─ Crane: ${fmt(craneHours)} hrs`
                ];
              }
              return `Total: ${fmt(value)} hours`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { 
            color: axisColor,
            font: {
              size: 11
            }
          },
          grid: { 
            display: false
          }
        },
        y: {
          beginAtZero: true,
          title: { 
            display: true, 
            text: 'Total Hours', 
            color: axisColor 
          },
          ticks: { 
            color: axisColor 
          },
          grid: { 
            color: gridColor 
          }
        }
      }
    }
  });

  // Per-riser breakdown chart - Shows all three categories
  const perRiserCtx = document.getElementById('perRiserChart').getContext('2d');
  perRiserChart = new Chart(perRiserCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [
        { 
          label: 'Stick Build', 
          data: [], 
          backgroundColor: stickColor, 
          borderColor: stickColor, 
          borderWidth: 1,
          barPercentage: 0.8,
          categoryPercentage: 0.9
        },
        { 
          label: 'Prefab', 
          data: [], 
          backgroundColor: prefabColor, 
          borderColor: prefabColor, 
          borderWidth: 1,
          barPercentage: 0.8,
          categoryPercentage: 0.9
        },
        { 
          label: 'Crane', 
          data: [], 
          backgroundColor: craneColor, 
          borderColor: craneColor, 
          borderWidth: 1,
          barPercentage: 0.8,
          categoryPercentage: 0.9
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          labels: { 
            color: axisColor 
          } 
        },
        tooltip: {
          callbacks: {
            footer: function(tooltipItems) {
              if (tooltipItems.length > 0) {
                const dataIndex = tooltipItems[0].dataIndex;
                const prefabValue = perRiserChart.data.datasets[1].data[dataIndex] || 0;
                const craneValue = perRiserChart.data.datasets[2].data[dataIndex] || 0;
                const combinedPrefab = prefabValue + craneValue;
                return `Prefab+Crane Total: ${fmt(combinedPrefab)} hrs`;
              }
              return '';
            }
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true, 
          title: { 
            display: true, 
            text: 'Hours', 
            color: axisColor 
          }, 
          ticks: { 
            color: axisColor 
          }, 
          grid: { 
            color: gridColor 
          } 
        },
        x: { 
          ticks: { 
            color: axisColor 
          }, 
          grid: { 
            display: false
          } 
        } 
      }
    }
  });
}

function updateCharts(){
  if(!totalsChart || !perRiserChart) return;

  // Update totals comparison chart - Stick vs (Prefab + Crane)
  const stickTotal = totals.hours.stick;
  const prefabCraneTotal = totals.hours.prefab + totals.hours.crane;
  
  totalsChart.data.datasets[0].data = [
    Math.round(stickTotal * 100) / 100,
    Math.round(prefabCraneTotal * 100) / 100
  ];
  totalsChart.update('none');

  // Update per-riser breakdown chart
  const labels = [];
  const sData = [], pData = [], cData = [];
  
  Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
    const cells = tr.children;
    const label = cells[0].querySelector('input').value || '(unnamed)';
    labels.push(label);
    
    const sHours = parseFloat(cells[3].textContent) || 0;
    const pHours = parseFloat(cells[6].textContent) || 0;
    const cHours = parseFloat(cells[9].textContent) || 0;
    
    sData.push(Math.round(sHours * 100) / 100);
    pData.push(Math.round(pHours * 100) / 100);
    cData.push(Math.round(cHours * 100) / 100);
  });
  
  perRiserChart.data.labels = labels;
  perRiserChart.data.datasets[0].data = sData;
  perRiserChart.data.datasets[1].data = pData;
  perRiserChart.data.datasets[2].data = cData;
  perRiserChart.update('none');
}

function saveState(){
  const rows = Array.from(tableBody.querySelectorAll('tr')).map(tr => {
    const c = tr.children;
    return {
      area: c[0].querySelector('input').value || '',
      stickDays: c[1].querySelector('input').value || '',
      stickPeople: c[2].querySelector('input').value || '',
      prefabDays: c[4].querySelector('input').value || '',
      prefabPeople: c[5].querySelector('input').value || '',
      craneDays: c[7].querySelector('input').value || '',
      cranePeople: c[8].querySelector('input').value || ''
    };
  });
  const state = {
    projectName: projectNameEl.value || '',
    projectNumber: projectNumberEl.value || '',
    rows
  };
  localStorage.setItem('labour_calc_state', JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem('labour_calc_state');
  if(!raw) return;
  try {
    const state = JSON.parse(raw);
    projectNameEl.value = state.projectName || '';
    projectNumberEl.value = state.projectNumber || '';
    (state.rows||[]).forEach(r => addRow(r));
  } catch(e){ 
    console.error('Error loading state:', e);
  }
}

function exportJSON(){
  const raw = localStorage.getItem('labour_calc_state') || JSON.stringify({});
  const blob = new Blob([raw], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'labour_calculator_data.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const state = JSON.parse(reader.result);
      // clear existing
      tableBody.innerHTML = '';
      projectNameEl.value = state.projectName || '';
      projectNumberEl.value = state.projectNumber || '';
      (state.rows||[]).forEach(r => addRow(r));
      updateTotals();
      saveState();
      alert('Import successful!');
    } catch(e){
      alert('Could not import this file. Please ensure it is a valid JSON file exported from this calculator.');
      console.error('Import error:', e);
    }
  };
  reader.onerror = () => {
    alert('Error reading file.');
  };
  reader.readAsText(file);
}

function emailResults(){
  const pn = projectNameEl.value || 'Project';
  const pj = projectNumberEl.value || '';
  let body = `Labour Calculator Results%0D%0A`;
  body += `Project: ${pn}${pj ? ' | Job: '+pj: ''}%0D%0A%0D%0A`;
  body += `Area/Riser, Stick Hours, Prefab Hours, Crane Hours, Total%0D%0A`;
  Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
    const c = tr.children;
    const area = c[0].querySelector('input').value || '';
    const sH = c[3].textContent;
    const pH = c[6].textContent;
    const cH = c[9].textContent;
    const tH = c[10].textContent;
    body += `${area}, ${sH}, ${pH}, ${cH}, ${tH}%0D%0A`;
  });
  
  const stickTotal = totals.hours.stick;
  const prefabCraneTotal = totals.hours.prefab + totals.hours.crane;
  const savings = stickTotal > 0 ? ((stickTotal - prefabCraneTotal) / stickTotal) * 100 : 0;
  
  body += `%0D%0ATotals:%0D%0A`;
  body += `Stick Build: ${fmt(stickTotal)} h%0D%0A`;
  body += `Prefab: ${fmt(totals.hours.prefab)} h%0D%0A`;
  body += `Crane: ${fmt(totals.hours.crane)} h%0D%0A`;
  body += `Prefab + Crane Combined: ${fmt(prefabCraneTotal)} h%0D%0A`;
  body += `Total All: ${fmt(totals.hours.total)} h%0D%0A`;
  body += `%0D%0ASavings with Prefab: ${fmt(savings)}%%0D%0A`;
  
  const subject = encodeURIComponent(`Labour Calculator Results – ${pn}`);
  const href = `mailto:?subject=${subject}&body=${body}`;
  window.location.href = href;
}

// Event bindings
addRowBtn.addEventListener('click', () => addRow());
clearAllBtn.addEventListener('click', () => {
  if(confirm('Clear all rows and totals?')){
    tableBody.innerHTML='';
    updateTotals();
    saveState();
  }
});
emailBtn.addEventListener('click', emailResults);

// Export button
document.getElementById('btnExport').addEventListener('click', exportJSON);

// Import button - improved implementation
document.addEventListener('DOMContentLoaded', () => {
  const importBtn = document.getElementById('btnImport');
  const fileInput = document.getElementById('importFile');
  
  if (importBtn && fileInput) {
    // Make the file input properly hidden but still clickable
    fileInput.style.position = 'absolute';
    fileInput.style.left = '-9999px';
    fileInput.style.opacity = '0';
    fileInput.style.width = '0.1px';
    fileInput.style.height = '0.1px';
    
    importBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // Reset the file input value to allow re-importing the same file
      fileInput.value = '';
      
      // Trigger the file input click
      fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) {
        // Verify it's a JSON file
        if (file.type === 'application/json' || file.name.endsWith('.json')) {
          importJSON(file);
        } else {
          alert('Please select a valid JSON file.');
        }
      }
    });
  }
  
  // Initialize charts after DOM is ready
  buildCharts();
  loadState();
  if(tableBody.children.length === 0){
    // add one starter row
    addRow({area:'01'});
  }
  updateTotals();
});

// Project name and number save on input
projectNameEl.addEventListener('input', saveState);
projectNumberEl.addEventListener('input', saveState);
</script>
</body>
</html>